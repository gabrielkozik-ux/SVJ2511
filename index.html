<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hlasovací Systém SVJ - Komárovská 497/28</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .checkbox-lg { transform: scale(1.3); cursor: pointer; }
        .checkbox-xl { transform: scale(1.6); cursor: pointer; }
        
        /* Custom scrollbar for table body if needed */
        .max-h-table { max-height: 60vh; overflow-y: auto; }
        
        /* Disabled row style */
        .opacity-40 { opacity: 0.4; pointer-events: none; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen pb-20">

    <!-- Top Control Panel (Sticky) -->
    <div class="sticky top-0 z-50 bg-white shadow-lg border-b border-gray-300">
        
        <!-- Resolution Selector -->
        <div class="bg-blue-900 text-white p-3">
            <div class="container mx-auto flex flex-col md:flex-row justify-between items-center gap-3">
                <div class="flex items-center gap-2 w-full md:w-auto">
                    <span class="font-bold whitespace-nowrap"><i class="fas fa-gavel mr-2"></i>Usnesení:</span>
                    <select id="resolution-select" class="text-gray-900 text-sm rounded-lg block w-full p-2 border-none focus:ring-2 focus:ring-blue-500" onchange="changeResolution()">
                        <!-- Options populated by JS -->
                    </select>
                </div>
                <div class="text-xs bg-blue-800 px-3 py-1 rounded" id="quorum-info">
                    Potřebné kvórum: > 50% přítomných
                </div>
            </div>
        </div>

        <!-- Live Results Bar -->
        <div class="container mx-auto px-4 py-3">
            <div class="flex flex-col md:flex-row items-center gap-4 justify-between">
                
                <!-- Stats Grid -->
                <div class="grid grid-cols-3 gap-4 w-full md:w-auto text-center divide-x divide-gray-300">
                    <div class="px-2">
                        <div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider">Přítomno</div>
                        <div class="font-mono font-bold text-gray-700">
                            <span id="present-shares">0</span><span class="text-gray-400 text-sm">/733</span>
                        </div>
                    </div>
                    <div class="px-2">
                        <div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider">PRO</div>
                        <div class="font-mono font-bold text-blue-600">
                            <span id="yes-votes">0</span>
                        </div>
                    </div>
                    <div class="px-2 flex flex-col justify-center">
                        <div id="result-badge" class="px-2 py-1 rounded text-white font-bold text-lg bg-gray-400">
                            0.0 %
                        </div>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div class="flex-grow w-full md:w-auto relative pt-1">
                    <div class="flex mb-2 items-center justify-between">
                        <div class="text-right w-full">
                            <span id="status-text" class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded text-gray-600 bg-gray-200">
                                Čekání na hlasy
                            </span>
                        </div>
                    </div>
                    <div class="overflow-hidden h-4 mb-1 text-xs flex rounded bg-gray-200 border border-gray-300 relative">
                        <!-- Quorum marker line -->
                        <div id="quorum-marker" class="absolute top-0 bottom-0 w-0.5 bg-black z-10 opacity-50 border-l border-dashed border-gray-600" style="left: 50%" title="Potřebná hranice"></div>
                        <div id="progress-bar" style="width:0%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-blue-500 transition-all duration-500"></div>
                    </div>
                </div>

                <!-- Action Button -->
                <div>
                    <button onclick="saveRound()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded shadow-lg transition flex items-center gap-2">
                        <i class="fas fa-save"></i> <span>Uzavřít & Uložit</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- Left Column: Voting Table -->
        <div class="lg:col-span-2 space-y-4">
            
            <!-- Tools -->
            <div class="flex justify-between items-center bg-white p-3 rounded shadow-sm">
                <div class="flex gap-2">
                    <button onclick="toggleAllPresence(true)" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-1.5 rounded transition">
                        <i class="fas fa-user-check"></i> Všichni přítomni
                    </button>
                    <button onclick="toggleAllPresence(false)" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-1.5 rounded transition">
                        <i class="fas fa-user-slash"></i> Nikdo
                    </button>
                </div>
                <div class="h-6 w-px bg-gray-300 mx-2"></div>
                <div class="flex gap-2">
                    <button onclick="toggleAllVotes(true)" class="text-xs bg-blue-100 hover:bg-blue-200 text-blue-800 px-3 py-1.5 rounded transition font-bold">
                        <i class="fas fa-thumbs-up"></i> Všichni PRO
                    </button>
                    <button onclick="toggleAllVotes(false)" class="text-xs bg-red-100 hover:bg-red-200 text-red-800 px-3 py-1.5 rounded transition">
                        <i class="fas fa-times"></i> Zrušit hlasy
                    </button>
                </div>
            </div>

            <!-- Table -->
            <div class="bg-white rounded-lg shadow overflow-hidden border border-gray-200">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-800 text-white text-sm uppercase sticky top-0">
                        <tr>
                            <th class="p-3 w-10 text-center">#</th>
                            <th class="p-3">Vlastník (Jednotka)</th>
                            <th class="p-3 w-20 text-center">Podíl</th>
                            <th class="p-3 w-24 text-center bg-gray-700 cursor-pointer" title="Kliknutím označíte přítomnost">
                                <i class="fas fa-walking"></i><br>Přítomen
                            </th>
                            <th class="p-3 w-24 text-center bg-blue-900 cursor-pointer" title="Hlasování">
                                <i class="fas fa-vote-yea"></i><br>PRO
                            </th>
                        </tr>
                    </thead>
                    <tbody id="owners-table" class="divide-y divide-gray-200 text-sm">
                        <!-- Rows -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Right Column: History & Info -->
        <div class="lg:col-span-1 space-y-6">
            
            <!-- History Card -->
            <div class="bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden">
                <div class="bg-gray-100 px-4 py-3 border-b border-gray-200 font-bold text-gray-700 flex justify-between items-center">
                    <span><i class="fas fa-history mr-2"></i>Historie hlasování</span>
                    <button onclick="clearHistory()" class="text-xs text-red-500 hover:text-red-700 underline">Vymazat</button>
                </div>
                <div class="max-h-[500px] overflow-y-auto p-0">
                    <div id="history-list" class="divide-y divide-gray-100">
                        <div class="p-8 text-center text-gray-400 text-sm italic" id="empty-history-msg">
                            Zatím nebylo uzavřeno žádné hlasování.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Legend -->
            <div class="bg-blue-50 rounded-lg p-4 border border-blue-100 text-sm text-blue-800">
                <h4 class="font-bold mb-2">Jak to funguje:</h4>
                <ul class="list-disc pl-4 space-y-1">
                    <li>Nejprve označte <strong>přítomné</strong> vlastníky.</li>
                    <li>Nepřítomní nemohou hlasovat a nepočítají se do základu.</li>
                    <li>Procenta se počítají z podílů <strong>přítomných</strong>.</li>
                    <li>Pro Stanovy je potřeba 75 %, jinak 50 %.</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // --- DATA CONFIGURATION ---

        const resolutions = [
            { id: 1, title: "1. Volba předsedy (J. Kislenko) a zapisovatele", threshold: 50 },
            { id: 2, title: "2. Schválení nových stanov SVJ", threshold: 75, highlight: true },
            { id: 3, title: "3. Volba výboru SVJ (funkční období 5 let)", threshold: 50 },
            { id: 4, title: "4. Schválení účetní závěrky 2024", threshold: 50 },
            { id: 5, title: "5. Schválení výše měsíčních příspěvků", threshold: 50 },
            { id: 6, title: "6. Schválení odměny členů výboru (1.000 Kč)", threshold: 50 }
        ];

        // Cleaned owner data
        const owners = [
            { id: 1, unit: "497/1", name: "Ben-Chenni Zulicha", share: 45 },
            { id: 2, unit: "497/2", name: "Kraus Tomáš", share: 34 },
            { id: 3, unit: "497/3", name: "SJ Hanousek Petr a Kamila", share: 34 },
            { id: 4, unit: "497/4", name: "Stejskalová Terezie", share: 46 },
            { id: 5, unit: "497/5", name: "Švaříček Oldřich", share: 36 },
            { id: 6, unit: "497/6", name: "SJ Kislenko Jan a Zsuzsanna", share: 34 },
            { id: 7, unit: "497/7", name: "Oleksík Zdenek", share: 69 },
            { id: 8, unit: "497/8", name: "Horák Milan", share: 49 },
            { id: 9, unit: "497/9", name: "Jákl Petr Ing. Ph.D.", share: 36 },
            { id: 10, unit: "497/10", name: "Kislenko Zsuzsanna", share: 69 },
            { id: 11, unit: "497/11", name: "Toufar Jiří", share: 34 },
            { id: 12, unit: "497/12", name: "Bednařík Radek", share: 49 },
            { id: 13, unit: "497/13", name: "Bohunský Radek", share: 78 },
            { id: 14, unit: "497/14", name: "Neubauer Richard", share: 35 },
            { id: 15, unit: "497/15", name: "Rapčanová Slavomíra", share: 35 },
            { id: 16, unit: "497/16", name: "SJ Sláma Ladislav a Jana", share: 50 }
        ];

        // --- STATE ---
        let state = {
            currentResolutionIndex: 0,
            ownersStatus: owners.map(o => ({ 
                id: o.id, 
                present: false, // Default not present 
                votedYes: false 
            })),
            history: []
        };

        // --- INIT & RENDER ---

        function init() {
            // Populate Resolution Select
            const select = document.getElementById('resolution-select');
            resolutions.forEach((res, index) => {
                const opt = document.createElement('option');
                opt.value = index;
                opt.text = res.title;
                if (res.highlight) opt.className = "font-bold text-red-600 bg-red-50";
                select.appendChild(opt);
            });

            renderTable();
            updateStats();
        }

        function changeResolution() {
            const select = document.getElementById('resolution-select');
            state.currentResolutionIndex = parseInt(select.value);
            
            // Note: We keep presence, but clear votes when changing resolution? 
            // Usually easier to keep presence and just clear votes.
            toggleAllVotes(false); 
            updateStats();
            updateQuorumDisplay();
        }

        function updateQuorumDisplay() {
            const currentRes = resolutions[state.currentResolutionIndex];
            const info = document.getElementById('quorum-info');
            const marker = document.getElementById('quorum-marker');
            
            info.textContent = `Potřebné kvórum: > ${currentRes.threshold}% přítomných`;
            marker.style.left = `${currentRes.threshold}%`;
            
            if (currentRes.threshold > 50) {
                info.className = "text-xs bg-red-800 text-white px-3 py-1 rounded shadow animate-pulse";
            } else {
                info.className = "text-xs bg-blue-800 text-white px-3 py-1 rounded";
            }
        }

        function renderTable() {
            const tbody = document.getElementById('owners-table');
            tbody.innerHTML = '';

            owners.forEach((owner, index) => {
                const status = state.ownersStatus[index];
                const tr = document.createElement('tr');
                tr.id = `row-${owner.id}`;
                tr.className = status.present ? "bg-white hover:bg-gray-50 transition-colors" : "bg-gray-100 text-gray-400";

                tr.innerHTML = `
                    <td class="p-3 text-center font-mono text-xs text-gray-500">${index + 1}</td>
                    <td class="p-3">
                        <div class="font-bold text-sm text-blue-900">${owner.unit}</div>
                        <div class="text-sm truncate max-w-[200px]" title="${owner.name}">${owner.name}</div>
                    </td>
                    <td class="p-3 text-center font-mono text-sm">${owner.share}</td>
                    <td class="p-3 text-center border-l border-gray-200 bg-gray-50">
                        <input type="checkbox" 
                            class="checkbox-lg text-gray-600 focus:ring-gray-500 rounded" 
                            onchange="updatePresence(${index}, this.checked)"
                            ${status.present ? 'checked' : ''}>
                    </td>
                    <td class="p-3 text-center border-l border-gray-200 ${status.present ? 'bg-blue-50' : ''}">
                        <input type="checkbox" 
                            id="vote-${owner.id}"
                            class="checkbox-xl text-blue-600 focus:ring-blue-500 rounded disabled:opacity-0" 
                            onchange="updateVote(${index}, this.checked)"
                            ${status.votedYes ? 'checked' : ''}
                            ${!status.present ? 'disabled' : ''}>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            updateQuorumDisplay(); // Init quorum visual
        }

        // --- LOGIC ---

        function updatePresence(index, isPresent) {
            state.ownersStatus[index].present = isPresent;
            
            // If marked absent, remove vote
            if (!isPresent) {
                state.ownersStatus[index].votedYes = false;
            }

            renderTable(); // Re-render to update row styling/disabling
            updateStats();
        }

        function updateVote(index, isYes) {
            if (!state.ownersStatus[index].present) return; // Security check
            state.ownersStatus[index].votedYes = isYes;
            updateStats();
        }

        function toggleAllPresence(val) {
            state.ownersStatus.forEach(s => {
                s.present = val;
                if (!val) s.votedYes = false;
            });
            renderTable();
            updateStats();
        }

        function toggleAllVotes(val) {
            state.ownersStatus.forEach(s => {
                if (s.present) s.votedYes = val;
            });
            renderTable();
            updateStats();
        }

        function calculateResults() {
            let presentShares = 0;
            let yesShares = 0;

            state.ownersStatus.forEach((status, idx) => {
                const share = owners[idx].share;
                if (status.present) {
                    presentShares += share;
                    if (status.votedYes) {
                        yesShares += share;
                    }
                }
            });

            return { presentShares, yesShares };
        }

        function updateStats() {
            const { presentShares, yesShares } = calculateResults();
            const currentRes = resolutions[state.currentResolutionIndex];
            
            // Avoid division by zero
            const percentage = presentShares > 0 ? (yesShares / presentShares) * 100 : 0;
            const isPassed = percentage > currentRes.threshold;

            // DOM Updates
            document.getElementById('present-shares').textContent = presentShares;
            document.getElementById('yes-votes').textContent = yesShares;
            
            const badge = document.getElementById('result-badge');
            const bar = document.getElementById('progress-bar');
            const statusText = document.getElementById('status-text');

            badge.textContent = percentage.toFixed(1) + ' %';
            bar.style.width = percentage + '%';

            if (presentShares === 0) {
                statusText.textContent = "Žádní přítomní";
                statusText.className = "text-xs font-semibold inline-block py-1 px-2 uppercase rounded text-gray-600 bg-gray-200";
                badge.className = "px-2 py-1 rounded text-white font-bold text-lg bg-gray-400";
                bar.className = "h-full bg-gray-400";
            } else if (isPassed) {
                statusText.textContent = "SCHVÁLENO";
                statusText.className = "text-xs font-semibold inline-block py-1 px-2 uppercase rounded text-green-800 bg-green-200 animate-pulse";
                badge.className = "px-2 py-1 rounded text-white font-bold text-lg bg-green-600 shadow";
                bar.className = "h-full bg-green-500 transition-all duration-300";
            } else {
                statusText.textContent = "NEPŘIJATO";
                statusText.className = "text-xs font-semibold inline-block py-1 px-2 uppercase rounded text-red-800 bg-red-200";
                badge.className = "px-2 py-1 rounded text-white font-bold text-lg bg-red-500 shadow";
                bar.className = "h-full bg-red-500 transition-all duration-300";
            }
        }

        // --- HISTORY & SAVING ---

        function saveRound() {
            const { presentShares, yesShares } = calculateResults();
            const currentRes = resolutions[state.currentResolutionIndex];
            const percentage = presentShares > 0 ? (yesShares / presentShares) * 100 : 0;
            const isPassed = percentage > currentRes.threshold;

            if (presentShares === 0) {
                alert("Nelze uzavřít hlasování bez přítomných vlastníků.");
                return;
            }

            const record = {
                time: new Date().toLocaleTimeString(),
                title: currentRes.title,
                present: presentShares,
                votes: yesShares,
                percent: percentage.toFixed(1),
                passed: isPassed,
                threshold: currentRes.threshold
            };

            state.history.unshift(record); // Add to top
            renderHistory();
            
            // Optional: Auto-advance to next resolution
            // if (state.currentResolutionIndex < resolutions.length - 1) {
            //     document.getElementById('resolution-select').value = state.currentResolutionIndex + 1;
            //     changeResolution();
            // }
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            if (state.history.length === 0) {
                list.innerHTML = '<div class="p-8 text-center text-gray-400 text-sm italic" id="empty-history-msg">Zatím nebylo uzavřeno žádné hlasování.</div>';
                return;
            }

            list.innerHTML = '';
            state.history.forEach(rec => {
                const item = document.createElement('div');
                item.className = "p-3 hover:bg-gray-50 transition";
                item.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-xs text-gray-400 font-mono">${rec.time}</span>
                        <span class="px-2 py-0.5 rounded text-[10px] uppercase font-bold text-white ${rec.passed ? 'bg-green-500' : 'bg-red-500'}">
                            ${rec.passed ? 'PŘIJATO' : 'NEPŘIJATO'}
                        </span>
                    </div>
                    <div class="font-semibold text-gray-800 text-sm mb-2 leading-tight">${rec.title}</div>
                    <div class="flex justify-between text-xs text-gray-600 bg-gray-100 p-2 rounded">
                        <div>
                            <span class="block text-gray-400 text-[10px] uppercase">Pro/Přít.</span>
                            <span class="font-mono font-bold">${rec.votes}/${rec.present}</span>
                        </div>
                        <div class="text-right">
                            <span class="block text-gray-400 text-[10px] uppercase">Výsledek</span>
                            <span class="font-bold ${rec.passed ? 'text-green-600' : 'text-red-600'}">${rec.percent}%</span>
                            <span class="text-[9px] text-gray-400">(kvórum ${rec.threshold}%)</span>
                        </div>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function clearHistory() {
            if(confirm("Opravdu smazat historii?")) {
                state.history = [];
                renderHistory();
            }
        }

        // Start
        init();
    </script>
</body>
</html>
