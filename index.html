<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hlasovací Systém SVJ - v3.3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .checkbox-lg { transform: scale(1.3); cursor: pointer; }
        .checkbox-xl { transform: scale(1.6); cursor: pointer; }
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow: hidden; }
        
        /* Print styles */
        .minutes-preview {
            font-family: 'Times New Roman', serif;
            line-height: 1.5;
            color: black;
        }
        .minutes-preview h1 { font-size: 16pt; text-align: center; font-weight: bold; margin-bottom: 1em; }
        .minutes-preview h2 { font-size: 12pt; font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; }
        .minutes-preview p { margin-bottom: 0.8em; text-align: justify; }
        .minutes-preview .result-box { border: 1px solid #ccc; padding: 5px; background: #f9f9f9; font-family: sans-serif; font-size: 0.9em; }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen pb-20">

    <!-- Sticky Header -->
    <div class="sticky top-0 z-40 bg-white shadow-lg border-b border-gray-300">
        
        <!-- Resolution / Mode Selector -->
        <div id="top-bar" class="bg-blue-900 text-white p-3 transition-colors duration-500">
            <div class="container mx-auto flex flex-col xl:flex-row justify-between items-center gap-3">
                
                <!-- Main Controls -->
                <div class="flex flex-col md:flex-row items-center gap-2 w-full xl:w-auto">
                    <div class="flex items-center gap-2 w-full">
                        <span class="font-bold whitespace-nowrap text-sm md:text-base"><i class="fas fa-gavel mr-2"></i>Bod:</span>
                        <select id="resolution-select" class="text-gray-900 text-sm rounded block w-full p-2 border-none focus:ring-2 focus:ring-blue-500 max-w-md" onchange="changeMainResolution()">
                            <!-- Options by JS -->
                        </select>
                    </div>
                    
                    <button onclick="openAmendmentModal()" class="whitespace-nowrap bg-orange-500 hover:bg-orange-600 text-white text-xs md:text-sm font-bold py-2 px-3 rounded shadow border border-orange-600 flex items-center gap-1">
                        <i class="fas fa-pen-fancy"></i> Navrhnout změnu
                    </button>
                    
                    <button onclick="openMinutesModal()" class="whitespace-nowrap bg-purple-600 hover:bg-purple-700 text-white text-xs md:text-sm font-bold py-2 px-3 rounded shadow border border-purple-700 flex items-center gap-1">
                        <i class="fas fa-file-word"></i> Zápis
                    </button>

                     <button onclick="toggleModal('legal-modal')" class="whitespace-nowrap bg-gray-600 hover:bg-gray-700 text-white text-xs md:text-sm font-bold py-2 px-3 rounded shadow flex items-center gap-1" title="Právní tahák">
                        <i class="fas fa-balance-scale"></i> Právní tahák
                    </button>

                    <button onclick="resetApp()" class="whitespace-nowrap bg-red-800 hover:bg-red-900 text-white text-xs md:text-sm font-bold py-2 px-3 rounded shadow flex items-center gap-1" title="Vymazat všechna data">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>

                <!-- Active Mode Indicator -->
                <div class="flex items-center gap-2">
                    <div id="save-indicator" class="text-xs text-green-300 italic opacity-0 transition-opacity duration-1000">
                        <i class="fas fa-save"></i> Uloženo
                    </div>
                    <div id="amendment-indicator" class="hidden bg-orange-100 text-orange-800 px-3 py-1 rounded font-bold text-sm border border-orange-300 animate-pulse">
                        <i class="fas fa-exclamation-circle"></i> REŽIM POZMĚŇOVACÍHO NÁVRHU
                    </div>
                    <div class="text-xs bg-blue-800 px-3 py-1 rounded border border-blue-700" id="quorum-info">
                        Kvórum: > 50%
                    </div>
                </div>
            </div>
            
            <!-- Context Sub-header -->
            <div class="container mx-auto mt-2 pt-2 border-t border-blue-800 flex justify-between items-center">
                <div class="font-mono text-sm text-blue-200 truncate w-3/4">
                    Hlasujeme o: <span id="current-voting-title" class="font-bold text-white text-lg">...</span>
                </div>
                <button id="cancel-amendment-btn" onclick="cancelAmendmentMode()" class="hidden text-xs text-orange-200 hover:text-white underline whitespace-nowrap">
                    Zrušit návrh
                </button>
            </div>
        </div>

        <!-- Live Results Bar -->
        <div class="container mx-auto px-4 py-3 bg-white">
            <div class="flex flex-col md:flex-row items-center gap-4 justify-between">
                
                <!-- Stats -->
                <div class="grid grid-cols-3 gap-4 w-full md:w-auto text-center divide-x divide-gray-300">
                    <div class="px-2">
                        <div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider">Přítomno</div>
                        <div class="font-mono font-bold text-gray-700">
                            <span id="present-shares">0</span><span class="text-gray-400 text-sm">/733</span>
                        </div>
                    </div>
                    <div class="px-2">
                        <div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider">PRO</div>
                        <div class="font-mono font-bold text-blue-600">
                            <span id="yes-votes">0</span>
                        </div>
                    </div>
                    <div class="px-2 flex flex-col justify-center">
                        <div id="result-badge" class="px-2 py-1 rounded text-white font-bold text-lg bg-gray-400">
                            0.0 %
                        </div>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div class="flex-grow w-full md:w-auto relative pt-1">
                    <div class="flex mb-2 items-center justify-between">
                        <div class="text-right w-full">
                            <span id="status-text" class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded text-gray-600 bg-gray-200">
                                Čekání
                            </span>
                        </div>
                    </div>
                    <div class="overflow-hidden h-4 mb-1 text-xs flex rounded bg-gray-200 border border-gray-300 relative">
                        <div id="quorum-marker" class="absolute top-0 bottom-0 w-0.5 bg-black z-10 opacity-50 border-l border-dashed border-gray-600" style="left: 50%" title="Potřebná hranice"></div>
                        <div id="progress-bar" style="width:0%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-blue-500 transition-all duration-500"></div>
                    </div>
                </div>

                <!-- Action Button -->
                <div>
                    <button onclick="saveRound()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded shadow-lg transition flex items-center gap-2 transform hover:scale-105">
                        <i class="fas fa-save"></i> <span>UZAVŘÍT HLASOVÁNÍ</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Grid -->
    <div class="container mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left Column: Voting Table -->
        <div class="lg:col-span-2 space-y-4">
            <!-- Quick Tools -->
            <div class="flex justify-between items-center bg-white p-3 rounded shadow-sm border border-gray-200">
                <div class="flex gap-2">
                    <button onclick="toggleAllPresence(true)" class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-800 px-3 py-1.5 rounded transition border border-gray-300">Všichni přítomni</button>
                    <button onclick="toggleAllPresence(false)" class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-800 px-3 py-1.5 rounded transition border border-gray-300">Nikdo</button>
                </div>
                <div class="flex gap-2">
                    <button onclick="toggleAllVotes(true)" class="text-xs bg-blue-50 hover:bg-blue-100 text-blue-800 px-3 py-1.5 rounded transition font-bold border border-blue-200">Všichni PRO</button>
                    <button onclick="toggleAllVotes(false)" class="text-xs bg-red-50 hover:bg-red-100 text-red-800 px-3 py-1.5 rounded transition border border-red-200">Zrušit hlasy</button>
                </div>
            </div>

            <!-- Table -->
            <div class="bg-white rounded-lg shadow overflow-hidden border border-gray-200">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-800 text-white text-sm uppercase sticky top-0">
                        <tr>
                            <th class="p-3 w-10 text-center">#</th>
                            <th class="p-3">Vlastník / Zástupce</th>
                            <th class="p-3 w-20 text-center">Podíl</th>
                            <th class="p-3 w-24 text-center bg-gray-700 cursor-pointer" onclick="toggleAllPresence(true)"><i class="fas fa-walking"></i> Přít.</th>
                            <th class="p-3 w-24 text-center bg-blue-900 cursor-pointer" onclick="toggleAllVotes(true)"><i class="fas fa-vote-yea"></i> PRO</th>
                        </tr>
                    </thead>
                    <tbody id="owners-table" class="divide-y divide-gray-200 text-sm"></tbody>
                </table>
            </div>
        </div>

        <!-- Right Column: History -->
        <div class="lg:col-span-1 space-y-6">
            <div class="bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden">
                <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 font-bold text-gray-700 flex justify-between items-center">
                    <span><i class="fas fa-history mr-2"></i>Zápis hlasování</span>
                    <button onclick="clearHistory()" class="text-xs text-red-400 hover:text-red-600">Smazat</button>
                </div>
                <div class="max-h-[600px] overflow-y-auto p-0 bg-gray-50">
                    <div id="history-list" class="divide-y divide-gray-200"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Amendment -->
    <div id="amendment-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3">
                    <p class="text-2xl font-bold text-orange-600">Pozměňovací návrh</p>
                    <div class="cursor-pointer z-50" onclick="closeAmendmentModal()"><i class="fas fa-times"></i></div>
                </div>
                <div class="my-5">
                    <textarea id="amendment-text" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-orange-500" rows="3" placeholder="Znění změny..."></textarea>
                    <p class="text-sm text-gray-600 mt-4 mb-2">Kvórum:</p>
                    <select id="amendment-threshold" class="w-full p-2 border border-gray-300 rounded bg-gray-50">
                        <option value="50">Nadpoloviční většina přítomných (>50%)</option>
                        <option value="75">Tříčtvrteční většina (>75%)</option>
                        <option value="100">100% souhlas všech</option>
                    </select>
                </div>
                <div class="flex justify-end pt-2">
                    <button onclick="startAmendmentVoting()" class="px-4 bg-orange-500 p-3 rounded-lg text-white hover:bg-orange-600 font-bold">Zahájit hlasování</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Proxy (Zástupce) -->
    <div id="proxy-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50" onclick="toggleModal('proxy-modal')"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-sm mx-auto rounded shadow-lg z-50 overflow-y-auto">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3 border-b">
                    <p class="text-lg font-bold text-gray-800"><i class="fas fa-user-friends mr-2"></i>Nastavit zástupce</p>
                    <button onclick="toggleModal('proxy-modal')" class="text-gray-500 hover:text-gray-800"><i class="fas fa-times"></i></button>
                </div>
                <div class="my-4">
                    <p class="text-sm text-gray-600 mb-2">Vlastník: <strong id="proxy-owner-name"></strong></p>
                    <label class="block text-xs text-gray-500 uppercase font-bold mb-1">Jméno zástupce (na základě Plné moci):</label>
                    <input type="text" id="proxy-input-name" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500" placeholder="Např. Jan Novák">
                    <input type="hidden" id="proxy-owner-id">
                </div>
                <div class="flex justify-end pt-2 gap-2">
                    <button onclick="saveProxy()" class="px-3 bg-blue-600 py-2 rounded text-white hover:bg-blue-700 text-sm font-bold">Uložit</button>
                    <button onclick="removeProxy()" class="px-3 bg-red-100 py-2 rounded text-red-700 hover:bg-red-200 text-sm">Zrušit zastoupení</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Minutes Generation -->
    <div id="minutes-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50" onclick="toggleModal('minutes-modal')"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-4xl mx-auto rounded shadow-lg z-50 overflow-y-auto max-h-[90vh]">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3 border-b">
                    <p class="text-xl font-bold text-purple-800"><i class="fas fa-file-alt mr-2"></i>Generování Zápisu ze shromáždění</p>
                    <button onclick="toggleModal('minutes-modal')" class="text-gray-500 hover:text-gray-800"><i class="fas fa-times fa-lg"></i></button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-4">
                    <!-- Inputs -->
                    <div class="col-span-1 space-y-3 bg-gray-50 p-4 rounded text-sm">
                        <h3 class="font-bold text-gray-700 border-b pb-1">1. Údaje o schůzi</h3>
                        <div><label class="block text-gray-500 text-xs">Datum a Čas:</label><input type="text" id="min-date" class="w-full border rounded p-1" value="27. 11. 2025, 18:00"></div>
                        <div><label class="block text-gray-500 text-xs">Předsedající:</label><input type="text" id="min-chair" class="w-full border rounded p-1" value="Jan Kislenko"></div>
                        <div><label class="block text-gray-500 text-xs">Zapisovatel:</label><input type="text" id="min-scribe" class="w-full border rounded p-1" value="Mgr. Gabriel Kožík"></div>
                        <div><label class="block text-gray-500 text-xs">Ověřovatel:</label><input type="text" id="min-verify" class="w-full border rounded p-1" value="[Doplnit jméno]"></div>
                        <button onclick="generateMinutesText()" class="w-full bg-purple-600 text-white py-2 rounded font-bold hover:bg-purple-700 mt-2"><i class="fas fa-sync-alt mr-1"></i> Aktualizovat náhled</button>
                    </div>

                    <!-- Preview -->
                    <div class="col-span-2">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-bold text-gray-700">2. Náhled dokumentu</h3>
                            <button onclick="copyMinutes()" class="text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded hover:bg-blue-200"><i class="fas fa-copy mr-1"></i> Kopírovat text</button>
                        </div>
                        <div id="minutes-content" class="minutes-preview bg-white border border-gray-300 p-8 h-[500px] overflow-y-auto shadow-inner" contenteditable="true">
                            <!-- Generated content will appear here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Legal Cheat Sheet (RESTORED CONTENT) -->
    <div id="legal-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50" onclick="toggleModal('legal-modal')"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-2xl mx-auto rounded shadow-lg z-50 overflow-y-auto max-h-[90vh]">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3 border-b">
                    <p class="text-xl font-bold text-gray-800"><i class="fas fa-balance-scale mr-2"></i>Právní postup při změnách</p>
                    <button onclick="toggleModal('legal-modal')" class="text-gray-500 hover:text-gray-800"><i class="fas fa-times fa-lg"></i></button>
                </div>
                <div class="my-4 text-sm text-gray-700 space-y-3">
                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3">
                        <p class="font-bold">Základní pravidlo:</p>
                        <p>Nehlasujte rovnou o "nových stanovách" jako celku, pokud jsou navrženy změny. Musíte se k finální verzi propracovat přes <strong>hlasování o dílčích pozměňovacích návrzích</strong>.</p>
                    </div>
                    
                    <h3 class="font-bold text-lg mt-4">Postup krok za krokem:</h3>
                    <ol class="list-decimal pl-5 space-y-1">
                        <li><strong>Přednesení změny:</strong> Někdo navrhne: <em>"V článku X vypustit větu Y..."</em></li>
                        <li><strong>Hlasování o změně:</strong> Hlasuje se POUZE o této změně (většinou >50% přítomných).</li>
                        <li><strong>Výsledek:</strong> 
                            <ul class="list-disc pl-5 text-gray-500">
                                <li>Pokud projde: Návrh stanov se v tomto bodě mění.</li>
                                <li>Pokud neprojde: Zůstává původní text z pozvánky.</li>
                            </ul>
                        </li>
                        <li><strong>Finální hlasování:</strong> Až se vyřeší všechny změny, hlasuje se o <strong>Stanovách jako celku</strong> (ve znění přijatých změn).</li>
                    </ol>

                    <div class="bg-red-50 border-l-4 border-red-500 p-3 mt-4">
                        <p class="font-bold text-red-700">RIZIKO: Nepřítomní vlastníci</p>
                        <p>Pokud změníte podstatu návrhu (např. způsob placení), může to nepřítomný vlastník napadnout u soudu, protože "hlasoval per rollam" nebo dal plnou moc pro původní text. <br><strong>Doporučení:</strong> Na schůzi dělat jen upřesňující, ne koncepční změny.</p>
                    </div>

                     <div class="bg-blue-50 border-l-4 border-blue-400 p-3 mt-4">
                        <p class="font-bold text-blue-800">TIP: Ukládání dat</p>
                        <p>Tato aplikace nyní automaticky ukládá výsledky do vašeho prohlížeče. Pro generování zápisu je nutné každé hlasování kliknout na "Uzavřít hlasování".</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA ---
        const initialResolutions = [
            { id: 1, title: "1. Volba předsedy (J. Kislenko) a zapisovatele", threshold: 50, structureKey: 'II' },
            { id: 100, title: "2. Schválení programu schůze", threshold: 50, structureKey: 'III' },
            { id: 2, title: "3. Schválení nových stanov SVJ", threshold: 75, highlight: true, structureKey: 'IV' },
            { id: 3, title: "4. Volba výboru SVJ", threshold: 50, structureKey: 'V' },
            { id: 4, title: "5. Schválení účetní závěrky 2024", threshold: 50, structureKey: 'GENERIC' },
            { id: 5, title: "6. Schválení výše příspěvků", threshold: 50, structureKey: 'GENERIC' },
            { id: 6, title: "7. Schválení odměny výboru", threshold: 50, structureKey: 'GENERIC' }
        ];

        const ownersInitial = [
            { id: 1, unit: "497/1", name: "Ben-Chenni Zulicha", share: 45 },
            { id: 2, unit: "497/2", name: "Kraus Tomáš", share: 34 },
            { id: 3, unit: "497/3", name: "SJ Hanousek Petr a Kamila", share: 34 },
            { id: 4, unit: "497/4", name: "Stejskalová Terezie", share: 46 },
            { id: 5, unit: "497/5", name: "Švaříček Oldřich", share: 36 },
            { id: 6, unit: "497/6", name: "SJ Kislenko Jan a Zsuzsanna", share: 34 },
            { id: 7, unit: "497/7", name: "Oleksík Zdenek", share: 69 },
            { id: 8, unit: "497/8", name: "Horák Milan", share: 49 },
            { id: 9, unit: "497/9", name: "Jákl Petr Ing. Ph.D.", share: 36 },
            { id: 10, unit: "497/10", name: "Kislenko Zsuzsanna", share: 69 },
            { id: 11, unit: "497/11", name: "Toufar Jiří", share: 34 },
            { id: 12, unit: "497/12", name: "Bednařík Radek", share: 49 },
            { id: 13, unit: "497/13", name: "Bohunský Radek", share: 78 },
            { id: 14, unit: "497/14", name: "Neubauer Richard", share: 35 },
            { id: 15, unit: "497/15", name: "Rapčanová Slavomíra", share: 35 },
            { id: 16, unit: "497/16", name: "SJ Sláma Ladislav a Jana", share: 50 }
        ];

        const TOTAL_SHARES_ALL = 733;
        const STORAGE_KEY = 'svj_voting_data_v3';

        let state = {
            mode: 'standard',
            resolutions: JSON.parse(JSON.stringify(initialResolutions)),
            currentIndex: 0,
            amendment: null,
            owners: ownersInitial.map(o => ({ ...o, present: false, votedYes: false, proxy: null })),
            history: []
        };

        function init() {
            loadFromStorage();
            renderResolutionSelect();
            renderTable();
            updateUI();
            updateHistory();
        }

        // --- STORAGE LOGIC ---
        function saveToStorage() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            showSaveIndicator();
        }

        function loadFromStorage() {
            const data = localStorage.getItem(STORAGE_KEY);
            if (data) {
                try {
                    const parsed = JSON.parse(data);
                    // Minimal validity check
                    if (parsed.owners && parsed.resolutions) {
                        state = parsed;
                        console.log("Data loaded from storage");
                    }
                } catch (e) {
                    console.error("Failed to load storage", e);
                }
            }
        }

        function resetApp() {
            if(confirm("POZOR: Opravdu chcete vymazat všechna uložená data, historii i nastavené zástupce? Tuto akci nelze vzít zpět.")) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }

        function showSaveIndicator() {
            const el = document.getElementById('save-indicator');
            el.classList.remove('opacity-0');
            setTimeout(() => el.classList.add('opacity-0'), 1500);
        }

        // --- CORE UI ---
        function renderResolutionSelect() {
            const select = document.getElementById('resolution-select');
            select.innerHTML = '';
            state.resolutions.forEach((res, index) => {
                const opt = document.createElement('option');
                opt.value = index;
                opt.text = res.modified ? `[UPRAVENO] ${res.title}` : res.title;
                if (res.highlight) opt.className = "font-bold text-red-600 bg-red-50";
                select.appendChild(opt);
            });
            select.value = state.currentIndex;
        }

        function renderTable() {
            const tbody = document.getElementById('owners-table');
            tbody.innerHTML = '';
            state.owners.forEach((o, idx) => {
                const tr = document.createElement('tr');
                tr.className = o.present ? "bg-white hover:bg-gray-50" : "bg-gray-100 text-gray-400";
                
                // Proxy logic in Name column
                let nameHtml = `<div class="font-bold text-blue-900 text-sm">${o.unit}</div>`;
                if (o.proxy) {
                    nameHtml += `<div class="text-xs text-purple-700 font-bold"><i class="fas fa-user-friends"></i> Zast.: ${o.proxy}</div>`;
                    nameHtml += `<div class="text-xs text-gray-400 line-through">${o.name}</div>`;
                } else {
                    nameHtml += `<div class="text-xs text-gray-600">${o.name}</div>`;
                }

                tr.innerHTML = `
                    <td class="p-3 text-center text-xs font-mono">${idx + 1}</td>
                    <td class="p-3 relative group">
                        ${nameHtml}
                        <button onclick="openProxyModal(${idx})" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-300 hover:text-blue-500 opacity-0 group-hover:opacity-100 transition p-2" title="Nastavit zástupce">
                            <i class="fas fa-pen"></i>
                        </button>
                    </td>
                    <td class="p-3 text-center text-sm font-mono">${o.share}</td>
                    <td class="p-3 text-center border-l bg-gray-50"><input type="checkbox" class="checkbox-lg accent-gray-600" ${o.present ? 'checked' : ''} onchange="setPresence(${idx}, this.checked)"></td>
                    <td class="p-3 text-center border-l ${o.present ? 'bg-blue-50' : ''}"><input type="checkbox" class="checkbox-xl accent-blue-600 disabled:opacity-0" ${o.votedYes ? 'checked' : ''} ${!o.present ? 'disabled' : ''} onchange="setVote(${idx}, this.checked)"></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function setPresence(idx, val) { state.owners[idx].present = val; if(!val) state.owners[idx].votedYes = false; renderTable(); updateUI(); saveToStorage(); }
        function setVote(idx, val) { if(!state.owners[idx].present) return; state.owners[idx].votedYes = val; updateUI(); saveToStorage(); }
        function toggleAllPresence(val) { state.owners.forEach(o => { o.present = val; if(!val) o.votedYes = false; }); renderTable(); updateUI(); saveToStorage(); }
        function toggleAllVotes(val) { state.owners.forEach(o => { if(o.present) o.votedYes = val; }); renderTable(); updateUI(); saveToStorage(); }

        // --- PROXY LOGIC ---
        let currentEditingProxyId = null;

        function openProxyModal(idx) {
            currentEditingProxyId = idx;
            const owner = state.owners[idx];
            document.getElementById('proxy-owner-name').textContent = owner.name;
            document.getElementById('proxy-input-name').value = owner.proxy || '';
            toggleModal('proxy-modal');
        }

        function saveProxy() {
            const val = document.getElementById('proxy-input-name').value.trim();
            if (currentEditingProxyId !== null) {
                state.owners[currentEditingProxyId].proxy = val ? val : null;
                renderTable();
                saveToStorage();
                toggleModal('proxy-modal');
            }
        }

        function removeProxy() {
            document.getElementById('proxy-input-name').value = '';
            saveProxy();
        }

        function calculate() {
            const present = state.owners.reduce((acc, o) => o.present ? acc + o.share : acc, 0);
            const votes = state.owners.reduce((acc, o) => (o.present && o.votedYes) ? acc + o.share : acc, 0);
            return { present, votes };
        }

        function updateUI() {
            const { present, votes } = calculate();
            let currentTitle, threshold;
            
            if (state.mode === 'amendment') {
                currentTitle = `POZMĚŇOVACÍ NÁVRH: ${state.amendment.text}`;
                threshold = state.amendment.threshold;
            } else {
                const res = state.resolutions[state.currentIndex];
                currentTitle = res.modified ? `${res.title} (ve znění změn)` : res.title;
                threshold = res.threshold;
            }

            const percent = present > 0 ? (votes / present) * 100 : 0;
            const passed = percent > threshold;

            document.getElementById('current-voting-title').textContent = state.mode === 'amendment' ? "POZMĚŇOVACÍ NÁVRH" : state.resolutions[state.currentIndex].title;
            document.getElementById('present-shares').textContent = present;
            document.getElementById('yes-votes').textContent = votes;
            document.getElementById('result-badge').textContent = percent.toFixed(1) + ' %';
            document.getElementById('progress-bar').style.width = percent + '%';
            document.getElementById('quorum-marker').style.left = threshold + '%';
            document.getElementById('quorum-info').textContent = `Kvórum: > ${threshold}%`;
            
            const status = document.getElementById('status-text');
            const badge = document.getElementById('result-badge');
            const bar = document.getElementById('progress-bar');
            
            if (present === 0) {
                status.textContent = "ČEKÁNÍ"; badge.className = "px-2 py-1 rounded text-white font-bold text-lg bg-gray-400"; bar.className = "h-full bg-gray-400";
            } else if (passed) {
                status.textContent = "SCHVÁLENO"; badge.className = "px-2 py-1 rounded text-white font-bold text-lg bg-green-600 shadow"; bar.className = "h-full bg-green-500";
            } else {
                status.textContent = "NEPŘIJATO"; badge.className = "px-2 py-1 rounded text-white font-bold text-lg bg-red-500 shadow"; bar.className = "h-full bg-red-500";
            }

            const topBar = document.getElementById('top-bar');
            if (state.mode === 'amendment') {
                topBar.classList.remove('bg-blue-900'); topBar.classList.add('bg-orange-700');
                document.getElementById('amendment-indicator').classList.remove('hidden');
                document.getElementById('cancel-amendment-btn').classList.remove('hidden');
            } else {
                topBar.classList.add('bg-blue-900'); topBar.classList.remove('bg-orange-700');
                document.getElementById('amendment-indicator').classList.add('hidden');
                document.getElementById('cancel-amendment-btn').classList.add('hidden');
            }
        }

        function saveRound() {
            const { present, votes } = calculate();
            if (present === 0) { alert("Nelze uzavřít bez přítomných."); return; }

            const percent = (votes / present) * 100;
            let passed, threshold, title, type, resolutionId, structureKey;

            if (state.mode === 'amendment') {
                threshold = state.amendment.threshold;
                passed = percent > threshold;
                title = `ZMĚNA: ${state.amendment.text.substring(0, 50)}...`;
                type = 'amendment';
                resolutionId = state.resolutions[state.currentIndex].id;
                structureKey = 'AMENDMENT';
            } else {
                const res = state.resolutions[state.currentIndex];
                threshold = res.threshold;
                passed = percent > threshold;
                title = res.modified ? `${res.title} (UPRAVENO)` : res.title;
                type = 'standard';
                resolutionId = res.id;
                structureKey = res.structureKey;
            }

            if (type === 'amendment' && passed) {
                if(confirm("Pozměňovací návrh byl PŘIJAT.\n\nMám označit hlavní usnesení jako 'UPRAVENO'?")) {
                    state.resolutions[state.currentIndex].modified = true;
                    renderResolutionSelect();
                }
            }

            const presencePercentOfTotal = (present / TOTAL_SHARES_ALL) * 100;
            const presenceMap = state.owners.filter(o => o.present).map(o => o.proxy ? `${o.proxy} (za ${o.name})` : o.name);

            state.history.unshift({
                time: new Date().toLocaleTimeString(),
                title, type, present, votes,
                percent: percent.toFixed(1),
                threshold, passed,
                resolutionId,
                structureKey,
                presencePercentOfTotal: presencePercentOfTotal.toFixed(2),
                fullText: state.mode === 'amendment' ? state.amendment.text : title,
                attendeesSnapshot: presenceMap
            });

            updateHistory();
            saveToStorage();

            if (state.mode === 'amendment') { state.mode = 'standard'; state.amendment = null; }
            toggleAllVotes(false);
            updateUI();
        }

        // --- AMENDMENT & NAVIGATION ---
        function openAmendmentModal() { toggleModal('amendment-modal'); document.getElementById('amendment-text').value=''; document.getElementById('amendment-text').focus(); }
        function closeAmendmentModal() { toggleModal('amendment-modal'); }
        function startAmendmentVoting() {
            const text = document.getElementById('amendment-text').value;
            if (!text.trim()) return;
            state.amendment = { text, threshold: parseInt(document.getElementById('amendment-threshold').value) };
            state.mode = 'amendment';
            toggleAllVotes(false);
            closeAmendmentModal();
            updateUI();
            saveToStorage();
        }
        function cancelAmendmentMode() { if (confirm("Zrušit?")) { state.mode = 'standard'; state.amendment = null; toggleAllVotes(false); updateUI(); saveToStorage(); } }
        function changeMainResolution() { 
            if (state.mode === 'amendment' && !confirm("Zahodit změnu?")) return;
            state.mode = 'standard';
            state.currentIndex = parseInt(document.getElementById('resolution-select').value);
            toggleAllVotes(false);
            updateUI();
            saveToStorage();
        }

        // --- MINUTES GENERATION ---
        function openMinutesModal() { toggleModal('minutes-modal'); generateMinutesText(); }
        function getVoteResultForResolution(resId) { return state.history.find(h => h.resolutionId === resId && h.type === 'standard'); }

        function formatVoteBlock(resId, voteNumber) {
            const res = getVoteResultForResolution(resId);
            if (!res) return `<div class="result-box text-red-600">[Hlasování č. ${voteNumber} nebylo dosud provedeno]</div>`;
            const proti = 100 - parseFloat(res.percent);
            return `<div class="result-box"><strong>Hlasování č. ${voteNumber}:</strong><br>PRO: ${res.percent} % | PROTI/ZDRŽEL SE: ${proti.toFixed(1)} %<br>Usnesení ${res.passed ? '<span style="color:green; font-weight:bold;">BYLO PŘIJATO</span>' : '<span style="color:red; font-weight:bold;">NEBYLO PŘIJATO</span>'}.</div>`;
        }

        function generateMinutesText() {
            const date = document.getElementById('min-date').value;
            const chair = document.getElementById('min-chair').value;
            const scribe = document.getElementById('min-scribe').value;
            const verify = document.getElementById('min-verify').value;
            const lastVote = state.history[0];
            const presenceTotal = lastVote ? lastVote.presencePercentOfTotal : "[Doplnit]";

            // Generate attendees list from current state
            const attendeesList = state.owners
                .filter(o => o.present)
                .map(o => o.proxy ? `${o.proxy} (na základě plné moci za vl. ${o.name})` : o.name)
                .join(', ');

            let html = `
            <h1>ZÁPIS ZE ZASEDÁNÍ SHROMÁŽDĚNÍ SPOLEČENSTVÍ VLASTNÍKŮ</h1>
            <p><strong>Název:</strong> SVJ Komárovská 28, Brno | <strong>IČ:</strong> 26241153<br>
            <strong>Datum:</strong> ${date} | <strong>Místo:</strong> Komárovská 28, Brno</p>

            <h2>I. Zahájení a prezence</h2>
            <p>Zasedání zahájil ${chair}.</p>
            <p><strong>Přítomni:</strong> ${attendeesList || 'Zatím nikdo nevybrán'}.</p>
            <p>Celková účast: <strong>${presenceTotal} %</strong> všech hlasů. Shromáždění ${parseFloat(presenceTotal) > 50 ? 'JE' : 'NENÍ'} usnášeníschopné.</p>

            <h2>II. Volba orgánů</h2>
            <p>Předsedající: ${chair}, Zapisovatel: ${scribe}, Ověřovatel: ${verify}</p>
            ${formatVoteBlock(1, 1)}

            <h2>III. Schválení programu</h2>
            ${formatVoteBlock(100, 2)}

            <h2>IV. Stanovy</h2>
            <p>Schválení nových stanov.</p>
            ${formatVoteBlock(2, 3)}

            <h2>V. Volba výboru</h2>
            ${formatVoteBlock(3, 4)}

            <h2>VI. Ostatní (Hospodaření, Příspěvky, Odměny)</h2>
            <p>Účetní závěrka: ${formatVoteBlock(4, 5)}</p>
            <p>Příspěvky: ${formatVoteBlock(5, 6)}</p>
            <p>Odměny: ${formatVoteBlock(6, 7)}</p>

            <h2>VII. Závěr</h2>
            <p>Zapsal: ${scribe} ....................................</p>
            `;
            document.getElementById('minutes-content').innerHTML = html;
        }

        function copyMinutes() {
            const content = document.getElementById('minutes-content');
            const range = document.createRange(); range.selectNode(content);
            window.getSelection().removeAllRanges(); window.getSelection().addRange(range);
            try { document.execCommand('copy'); alert("Zkopírováno!"); } catch(e) { alert("Zkopírujte ručně."); }
            window.getSelection().removeAllRanges();
        }

        // --- HELPERS ---
        function updateHistory() {
            const list = document.getElementById('history-list'); list.innerHTML = '';
            state.history.forEach(rec => {
                const isAm = rec.type === 'amendment';
                const row = document.createElement('div');
                row.className = `p-3 ${isAm ? 'bg-orange-50 border-l-4 border-orange-400' : 'bg-white border-l-4 border-blue-400'}`;
                row.innerHTML = `<div class="flex justify-between items-start mb-1"><span class="text-xs text-gray-400 font-mono">${rec.time}</span><span class="px-2 py-0.5 rounded text-[10px] uppercase font-bold text-white ${rec.passed ? 'bg-green-600' : 'bg-red-500'}">${rec.passed ? 'PŘIJATO' : 'NEPŘIJATO'}</span></div><div class="font-bold text-sm text-gray-800 mb-1 leading-tight">${isAm ? '<span class="text-orange-600">POZMĚŇOVACÍ NÁVRH:</span>' : ''} ${rec.title}</div><div class="flex justify-between text-xs text-gray-500"><span>Pro: <b>${rec.votes}</b> / Přít: ${rec.present}</span><span><b>${rec.percent}%</b></span></div>`;
                list.appendChild(row);
            });
        }
        function clearHistory() { if(confirm("Smazat historii v tomto zobrazení? (Data v paměti zůstanou do resetu)")) { state.history = []; updateHistory(); saveToStorage(); } }
        function toggleModal(id) { const m=document.getElementById(id); m.classList.toggle('opacity-0'); m.classList.toggle('pointer-events-none'); document.body.classList.toggle('modal-active'); }

        init();
    </script>
</body>
</html>
